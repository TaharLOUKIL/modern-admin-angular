import { __decorate } from "tslib";
import { Directive, Input, OnInit, OnDestroy, ComponentRef, ComponentFactoryResolver, ViewContainerRef, TemplateRef, Renderer2, EmbeddedViewRef } from '@angular/core';
import { BlockUIContentComponent } from '../components/block-ui-content/block-ui-content.component';
import { BlockUIInstanceService } from '../services/block-ui-instance.service';
import { BlockUIDefaultName } from '../constants/block-ui-default-name.constant';
import { BlockUIService } from '../services/block-ui.service';
var BlockUIDirective = /** @class */ (function () {
    function BlockUIDirective(blockUIService, blockUIInstanceService, viewRef, templateRef, renderer, componentFactoryResolver) {
        this.blockUIService = blockUIService;
        this.blockUIInstanceService = blockUIInstanceService;
        this.viewRef = viewRef;
        this.templateRef = templateRef;
        this.renderer = renderer;
        this.componentFactoryResolver = componentFactoryResolver;
    }
    Object.defineProperty(BlockUIDirective.prototype, "blockUI", {
        set: function (name) { this.blockTarget = name; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(BlockUIDirective.prototype, "blockUIMessage", {
        set: function (message) { this.message = message; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(BlockUIDirective.prototype, "blockUITemplate", {
        set: function (template) { this.template = template; },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(BlockUIDirective.prototype, "blockUIDelayStart", {
        set: function (delayStart) {
            this.delayStart = delayStart ? Number(delayStart) : null;
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(BlockUIDirective.prototype, "blockUIDelayStop", {
        set: function (delayStop) {
            this.delayStop = delayStop ? Number(delayStop) : null;
        },
        enumerable: true,
        configurable: true
    });
    ;
    BlockUIDirective.prototype.ngOnInit = function () {
        try {
            this.viewRef.createEmbeddedView(this.templateRef);
            var parentElement = this.getParentElement();
            if (parentElement && !this.isComponentInTemplate(parentElement)) {
                this.renderer.addClass(parentElement, 'block-ui__element');
                this.blockUIComponentRef = this.createComponent();
                var blockUIContent = this.findContentNode(this.viewRef.element.nativeElement);
                if (blockUIContent) {
                    var settings = this.blockUIInstanceService.getSettings();
                    parentElement.appendChild(blockUIContent);
                    this.blockUIComponentRef.instance.className = 'block-ui-wrapper--element';
                    this.blockUIComponentRef.instance.name = this.blockTarget || BlockUIDefaultName;
                    if (this.message)
                        this.blockUIComponentRef.instance.defaultMessage = this.message;
                    if (this.delayStart)
                        this.blockUIComponentRef.instance.delayStart = this.delayStart;
                    if (this.delayStop)
                        this.blockUIComponentRef.instance.delayStop = this.delayStop;
                    if (this.template || settings.template)
                        this.blockUIComponentRef.instance.templateCmp = this.template || settings.template;
                }
            }
        }
        catch (error) {
            console.error('ng-block-ui:', error);
        }
    };
    BlockUIDirective.prototype.isComponentInTemplate = function (element) {
        // Needed because of https://github.com/microsoft/TypeScript/issues/26235
        var targetElement = element || {};
        var children = targetElement.children;
        children = Array.from(children || []).reverse();
        return children.some(function (el) { return el && el.localName === 'block-ui'; });
    };
    BlockUIDirective.prototype.getParentElement = function () {
        var embeddedView = this.viewRef.get(0);
        return embeddedView.rootNodes[0];
    };
    // Needed for IE (#17)
    BlockUIDirective.prototype.findContentNode = function (element) {
        var nextSibling = element.nextSibling || {};
        var previousSibling = element.previousSibling || {};
        return [
            nextSibling,
            nextSibling.nextSibling,
            previousSibling,
            previousSibling.previousSibling
        ].find(function (e) { return e && e.localName === 'block-ui-content'; });
    };
    BlockUIDirective.prototype.createComponent = function () {
        var resolvedBlockUIComponent = this.componentFactoryResolver.resolveComponentFactory(BlockUIContentComponent);
        return this.viewRef.createComponent(resolvedBlockUIComponent);
    };
    BlockUIDirective.prototype.ngOnDestroy = function () {
        if (this.blockTarget) {
            this.blockUIService.reset(this.blockTarget);
        }
    };
    BlockUIDirective.ctorParameters = function () { return [
        { type: BlockUIService },
        { type: BlockUIInstanceService },
        { type: ViewContainerRef },
        { type: TemplateRef },
        { type: Renderer2 },
        { type: ComponentFactoryResolver }
    ]; };
    __decorate([
        Input()
    ], BlockUIDirective.prototype, "blockUI", null);
    __decorate([
        Input()
    ], BlockUIDirective.prototype, "blockUIMessage", null);
    __decorate([
        Input()
    ], BlockUIDirective.prototype, "blockUITemplate", null);
    __decorate([
        Input()
    ], BlockUIDirective.prototype, "blockUIDelayStart", null);
    __decorate([
        Input()
    ], BlockUIDirective.prototype, "blockUIDelayStop", null);
    BlockUIDirective = __decorate([
        Directive({ selector: '[blockUI]' })
    ], BlockUIDirective);
    return BlockUIDirective;
}());
export { BlockUIDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stdWkuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctYmxvY2stdWkvIiwic291cmNlcyI6WyJkaXJlY3RpdmVzL2Jsb2NrLXVpLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxZQUFZLEVBQ1osd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQixXQUFXLEVBQ1gsU0FBUyxFQUNULGVBQWUsRUFDaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFDcEcsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDL0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFDakYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRzlEO0lBdUJFLDBCQUNVLGNBQThCLEVBQzlCLHNCQUE4QyxFQUM5QyxPQUF5QixFQUN6QixXQUE2QixFQUM3QixRQUFtQixFQUNuQix3QkFBa0Q7UUFMbEQsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsWUFBTyxHQUFQLE9BQU8sQ0FBa0I7UUFDekIsZ0JBQVcsR0FBWCxXQUFXLENBQWtCO1FBQzdCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtJQUN4RCxDQUFDO0lBckJMLHNCQUFJLHFDQUFPO2FBQVgsVUFBWSxJQUFTLElBQUksSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDOzs7T0FBQTtJQUFBLENBQUM7SUFFcEQsc0JBQUksNENBQWM7YUFBbEIsVUFBbUIsT0FBWSxJQUFJLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQzs7O09BQUE7SUFBQSxDQUFDO0lBRTdELHNCQUFJLDZDQUFlO2FBQW5CLFVBQW9CLFFBQWEsSUFBSSxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7OztPQUFBO0lBQUEsQ0FBQztJQUVqRSxzQkFBSSwrQ0FBaUI7YUFBckIsVUFBc0IsVUFBZTtZQUNuQyxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDM0QsQ0FBQzs7O09BQUE7SUFBQSxDQUFDO0lBRUYsc0JBQUksOENBQWdCO2FBQXBCLFVBQXFCLFNBQWM7WUFDakMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ3hELENBQUM7OztPQUFBO0lBQUEsQ0FBQztJQVdGLG1DQUFRLEdBQVI7UUFDRSxJQUFJO1lBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDbEQsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFOUMsSUFBSSxhQUFhLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLEVBQUU7Z0JBQy9ELElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO2dCQUMzRCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNsRCxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUU5RSxJQUFJLGNBQWMsRUFBRTtvQkFDbEIsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUUzRCxhQUFhLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDO29CQUMxQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLFNBQVMsR0FBRywyQkFBMkIsQ0FBQztvQkFDMUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFBSSxrQkFBa0IsQ0FBQztvQkFDaEYsSUFBSSxJQUFJLENBQUMsT0FBTzt3QkFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO29CQUNsRixJQUFJLElBQUksQ0FBQyxVQUFVO3dCQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7b0JBQ3BGLElBQUksSUFBSSxDQUFDLFNBQVM7d0JBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztvQkFDakYsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxRQUFRO3dCQUNwQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUM7aUJBQ3RGO2FBQ0Y7U0FDRjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdEM7SUFDSCxDQUFDO0lBRU8sZ0RBQXFCLEdBQTdCLFVBQThCLE9BQVk7UUFDeEMseUVBQXlFO1FBQ3pFLElBQU0sYUFBYSxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDOUIsSUFBQSxpQ0FBUSxDQUFtQjtRQUNqQyxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDaEQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQUMsRUFBTyxJQUFLLE9BQUEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxTQUFTLEtBQUssVUFBVSxFQUFqQyxDQUFpQyxDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUVPLDJDQUFnQixHQUF4QjtRQUNFLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBeUIsQ0FBQztRQUVqRSxPQUFPLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFbkMsQ0FBQztJQUVELHNCQUFzQjtJQUNkLDBDQUFlLEdBQXZCLFVBQXdCLE9BQVk7UUFDbEMsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7UUFDOUMsSUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLGVBQWUsSUFBSSxFQUFFLENBQUM7UUFFdEQsT0FBTztZQUNMLFdBQVc7WUFDWCxXQUFXLENBQUMsV0FBVztZQUN2QixlQUFlO1lBQ2YsZUFBZSxDQUFDLGVBQWU7U0FDaEMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsS0FBSyxrQkFBa0IsRUFBdkMsQ0FBdUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFTywwQ0FBZSxHQUF2QjtRQUNFLElBQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLHVCQUF1QixDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDaEgsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxzQ0FBVyxHQUFYO1FBQ0UsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUM3QztJQUNILENBQUM7O2dCQXpFeUIsY0FBYztnQkFDTixzQkFBc0I7Z0JBQ3JDLGdCQUFnQjtnQkFDWixXQUFXO2dCQUNkLFNBQVM7Z0JBQ08sd0JBQXdCOztJQXBCNUQ7UUFEQyxLQUFLLEVBQUU7bURBQzJDO0lBRW5EO1FBREMsS0FBSyxFQUFFOzBEQUNvRDtJQUU1RDtRQURDLEtBQUssRUFBRTsyREFDd0Q7SUFFaEU7UUFEQyxLQUFLLEVBQUU7NkRBR1A7SUFFRDtRQURDLEtBQUssRUFBRTs0REFHUDtJQXJCVSxnQkFBZ0I7UUFENUIsU0FBUyxDQUFDLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxDQUFDO09BQ3hCLGdCQUFnQixDQWtHNUI7SUFBRCx1QkFBQztDQUFBLEFBbEdELElBa0dDO1NBbEdZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95LFxuICBDb21wb25lbnRSZWYsXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgVGVtcGxhdGVSZWYsXG4gIFJlbmRlcmVyMixcbiAgRW1iZWRkZWRWaWV3UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmxvY2tVSUNvbnRlbnRDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL2Jsb2NrLXVpLWNvbnRlbnQvYmxvY2stdWktY29udGVudC5jb21wb25lbnQnO1xuaW1wb3J0IHsgQmxvY2tVSUluc3RhbmNlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2Jsb2NrLXVpLWluc3RhbmNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQmxvY2tVSURlZmF1bHROYW1lIH0gZnJvbSAnLi4vY29uc3RhbnRzL2Jsb2NrLXVpLWRlZmF1bHQtbmFtZS5jb25zdGFudCc7XG5pbXBvcnQgeyBCbG9ja1VJU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2Jsb2NrLXVpLnNlcnZpY2UnO1xuXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbYmxvY2tVSV0nIH0pXG5leHBvcnQgY2xhc3MgQmxvY2tVSURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBibG9ja1VJQ29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8QmxvY2tVSUNvbnRlbnRDb21wb25lbnQ+O1xuICBibG9ja1RhcmdldDogc3RyaW5nO1xuICBtZXNzYWdlOiBhbnk7XG4gIHRlbXBsYXRlOiBhbnk7XG4gIGRlbGF5U3RhcnQ6IGFueTtcbiAgZGVsYXlTdG9wOiBhbnk7XG5cbiAgQElucHV0KClcbiAgc2V0IGJsb2NrVUkobmFtZTogYW55KSB7IHRoaXMuYmxvY2tUYXJnZXQgPSBuYW1lOyB9O1xuICBASW5wdXQoKVxuICBzZXQgYmxvY2tVSU1lc3NhZ2UobWVzc2FnZTogYW55KSB7IHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7IH07XG4gIEBJbnB1dCgpXG4gIHNldCBibG9ja1VJVGVtcGxhdGUodGVtcGxhdGU6IGFueSkgeyB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7IH07XG4gIEBJbnB1dCgpXG4gIHNldCBibG9ja1VJRGVsYXlTdGFydChkZWxheVN0YXJ0OiBhbnkpIHtcbiAgICB0aGlzLmRlbGF5U3RhcnQgPSBkZWxheVN0YXJ0ID8gTnVtYmVyKGRlbGF5U3RhcnQpIDogbnVsbDtcbiAgfTtcbiAgQElucHV0KClcbiAgc2V0IGJsb2NrVUlEZWxheVN0b3AoZGVsYXlTdG9wOiBhbnkpIHtcbiAgICB0aGlzLmRlbGF5U3RvcCA9IGRlbGF5U3RvcCA/IE51bWJlcihkZWxheVN0b3ApIDogbnVsbDtcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGJsb2NrVUlTZXJ2aWNlOiBCbG9ja1VJU2VydmljZSxcbiAgICBwcml2YXRlIGJsb2NrVUlJbnN0YW5jZVNlcnZpY2U6IEJsb2NrVUlJbnN0YW5jZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB2aWV3UmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByaXZhdGUgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4sXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJcbiAgKSB7IH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy52aWV3UmVmLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLnRlbXBsYXRlUmVmKTtcbiAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSB0aGlzLmdldFBhcmVudEVsZW1lbnQoKTtcblxuICAgICAgaWYgKHBhcmVudEVsZW1lbnQgJiYgIXRoaXMuaXNDb21wb25lbnRJblRlbXBsYXRlKHBhcmVudEVsZW1lbnQpKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MocGFyZW50RWxlbWVudCwgJ2Jsb2NrLXVpX19lbGVtZW50Jyk7XG4gICAgICAgIHRoaXMuYmxvY2tVSUNvbXBvbmVudFJlZiA9IHRoaXMuY3JlYXRlQ29tcG9uZW50KCk7XG4gICAgICAgIGxldCBibG9ja1VJQ29udGVudCA9IHRoaXMuZmluZENvbnRlbnROb2RlKHRoaXMudmlld1JlZi5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuXG4gICAgICAgIGlmIChibG9ja1VJQ29udGVudCkge1xuICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5ibG9ja1VJSW5zdGFuY2VTZXJ2aWNlLmdldFNldHRpbmdzKCk7XG5cbiAgICAgICAgICBwYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKGJsb2NrVUlDb250ZW50KTtcbiAgICAgICAgICB0aGlzLmJsb2NrVUlDb21wb25lbnRSZWYuaW5zdGFuY2UuY2xhc3NOYW1lID0gJ2Jsb2NrLXVpLXdyYXBwZXItLWVsZW1lbnQnO1xuICAgICAgICAgIHRoaXMuYmxvY2tVSUNvbXBvbmVudFJlZi5pbnN0YW5jZS5uYW1lID0gdGhpcy5ibG9ja1RhcmdldCB8fCBCbG9ja1VJRGVmYXVsdE5hbWU7XG4gICAgICAgICAgaWYgKHRoaXMubWVzc2FnZSkgdGhpcy5ibG9ja1VJQ29tcG9uZW50UmVmLmluc3RhbmNlLmRlZmF1bHRNZXNzYWdlID0gdGhpcy5tZXNzYWdlO1xuICAgICAgICAgIGlmICh0aGlzLmRlbGF5U3RhcnQpIHRoaXMuYmxvY2tVSUNvbXBvbmVudFJlZi5pbnN0YW5jZS5kZWxheVN0YXJ0ID0gdGhpcy5kZWxheVN0YXJ0O1xuICAgICAgICAgIGlmICh0aGlzLmRlbGF5U3RvcCkgdGhpcy5ibG9ja1VJQ29tcG9uZW50UmVmLmluc3RhbmNlLmRlbGF5U3RvcCA9IHRoaXMuZGVsYXlTdG9wO1xuICAgICAgICAgIGlmICh0aGlzLnRlbXBsYXRlIHx8IHNldHRpbmdzLnRlbXBsYXRlKVxuICAgICAgICAgICAgdGhpcy5ibG9ja1VJQ29tcG9uZW50UmVmLmluc3RhbmNlLnRlbXBsYXRlQ21wID0gdGhpcy50ZW1wbGF0ZSB8fCBzZXR0aW5ncy50ZW1wbGF0ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCduZy1ibG9jay11aTonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc0NvbXBvbmVudEluVGVtcGxhdGUoZWxlbWVudDogYW55KTogYm9vbGVhbiB7XG4gICAgLy8gTmVlZGVkIGJlY2F1c2Ugb2YgaHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC9UeXBlU2NyaXB0L2lzc3Vlcy8yNjIzNVxuICAgIGNvbnN0IHRhcmdldEVsZW1lbnQgPSBlbGVtZW50IHx8IHt9O1xuICAgIGxldCB7IGNoaWxkcmVuIH0gPSB0YXJnZXRFbGVtZW50O1xuICAgIGNoaWxkcmVuID0gQXJyYXkuZnJvbShjaGlsZHJlbiB8fCBbXSkucmV2ZXJzZSgpO1xuICAgIHJldHVybiBjaGlsZHJlbi5zb21lKChlbDogYW55KSA9PiBlbCAmJiBlbC5sb2NhbE5hbWUgPT09ICdibG9jay11aScpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYXJlbnRFbGVtZW50KCk6IEVsZW1lbnQge1xuICAgIGNvbnN0IGVtYmVkZGVkVmlldyA9IHRoaXMudmlld1JlZi5nZXQoMCkgYXMgRW1iZWRkZWRWaWV3UmVmPGFueT47XG5cbiAgICByZXR1cm4gZW1iZWRkZWRWaWV3LnJvb3ROb2Rlc1swXTtcblxuICB9XG5cbiAgLy8gTmVlZGVkIGZvciBJRSAoIzE3KVxuICBwcml2YXRlIGZpbmRDb250ZW50Tm9kZShlbGVtZW50OiBhbnkpIHtcbiAgICBjb25zdCBuZXh0U2libGluZyA9IGVsZW1lbnQubmV4dFNpYmxpbmcgfHwge307XG4gICAgY29uc3QgcHJldmlvdXNTaWJsaW5nID0gZWxlbWVudC5wcmV2aW91c1NpYmxpbmcgfHwge307XG5cbiAgICByZXR1cm4gW1xuICAgICAgbmV4dFNpYmxpbmcsXG4gICAgICBuZXh0U2libGluZy5uZXh0U2libGluZyxcbiAgICAgIHByZXZpb3VzU2libGluZyxcbiAgICAgIHByZXZpb3VzU2libGluZy5wcmV2aW91c1NpYmxpbmdcbiAgICBdLmZpbmQoKGUpID0+IGUgJiYgZS5sb2NhbE5hbWUgPT09ICdibG9jay11aS1jb250ZW50Jyk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNvbXBvbmVudCgpIHtcbiAgICBjb25zdCByZXNvbHZlZEJsb2NrVUlDb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShCbG9ja1VJQ29udGVudENvbXBvbmVudCk7XG4gICAgcmV0dXJuIHRoaXMudmlld1JlZi5jcmVhdGVDb21wb25lbnQocmVzb2x2ZWRCbG9ja1VJQ29tcG9uZW50KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmJsb2NrVGFyZ2V0KSB7XG4gICAgICB0aGlzLmJsb2NrVUlTZXJ2aWNlLnJlc2V0KHRoaXMuYmxvY2tUYXJnZXQpO1xuICAgIH1cbiAgfVxufVxuIl19