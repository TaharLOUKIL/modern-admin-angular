import { __assign, __decorate, __read, __spread } from "tslib";
import { Component, OnInit, AfterViewInit, AfterViewChecked, OnDestroy, ViewEncapsulation, Input, ViewChild, ComponentRef, TemplateRef, ComponentFactoryResolver, ViewContainerRef, ChangeDetectorRef } from '@angular/core';
import { BlockUIInstanceService } from '../../services/block-ui-instance.service';
import { BlockUIActions } from '../../constants/block-ui-actions.constant';
import { BlockUIDefaultName } from '../../constants/block-ui-default-name.constant';
import { styles } from './block-ui-content.component.style';
import { template } from './block-ui-content.component.template';
var BlockUIContentComponent = /** @class */ (function () {
    function BlockUIContentComponent(blockUI, resolver, changeDetectionRef) {
        this.blockUI = blockUI;
        this.resolver = resolver;
        this.changeDetectionRef = changeDetectionRef;
        this.name = BlockUIDefaultName;
        this.defaultBlockState = {
            startTimeouts: [],
            stopTimeouts: [],
            updateTimeouts: [],
            blockCount: 0,
            startCallCount: 0,
            stopCallCount: 0
        };
        this.state = __assign({}, this.defaultBlockState);
    }
    BlockUIContentComponent.prototype.ngOnInit = function () {
        this.settings = this.blockUI.getSettings();
        this.blockUISubscription = this.subscribeToBlockUI(this.blockUI.observe());
    };
    BlockUIContentComponent.prototype.ngAfterViewInit = function () {
        try {
            if (!this.templateCmp) {
                return false;
            }
            if (this.templateCmp instanceof TemplateRef) {
                this.templateOutlet.createEmbeddedView(this.templateCmp);
            }
            else {
                var templateComp = this.resolver.resolveComponentFactory(this.templateCmp);
                this.templateCompRef = this.templateOutlet.createComponent(templateComp);
                this.updateBlockTemplate(this.message);
            }
        }
        catch (error) {
            console.error('ng-block-ui:', error);
        }
    };
    BlockUIContentComponent.prototype.ngAfterViewChecked = function () {
        this.detectChanges();
    };
    BlockUIContentComponent.prototype.subscribeToBlockUI = function (blockUI$) {
        var _this = this;
        return blockUI$.subscribe(function (event) { return _this.onDispatchedEvent(event); });
    };
    BlockUIContentComponent.prototype.onDispatchedEvent = function (event) {
        switch (event.action) {
            case BlockUIActions.START:
                this.onStart(event);
                break;
            case BlockUIActions.STOP:
                this.onStop(event);
                break;
            case BlockUIActions.UPDATE:
                this.onUpdate(event);
                break;
            case BlockUIActions.RESET:
                this.onReset(event);
                break;
            case BlockUIActions.RESET_GLOBAL:
                this.resetState();
                break;
            case BlockUIActions.UNSUBSCRIBE:
                this.onStop(event);
                this.onUnsubscribe(event.name);
                break;
        }
    };
    BlockUIContentComponent.prototype.onStart = function (_a) {
        var _this = this;
        var name = _a.name, message = _a.message;
        if (name === this.name) {
            var delay = this.delayStart || this.settings.delayStart || 0;
            this.state.startCallCount += 1;
            var startTimeout = setTimeout(function () {
                _this.state.blockCount += 1;
                _this.showBlock(message);
                _this.updateInstanceBlockCount();
            }, delay);
            this.state.startTimeouts.push(startTimeout);
        }
    };
    BlockUIContentComponent.prototype.onStop = function (_a) {
        var _this = this;
        var name = _a.name;
        if (name === this.name) {
            var stopCount = this.state.stopCallCount + 1;
            if (this.state.startCallCount - stopCount >= 0) {
                var delay = this.delayStop || this.settings.delayStop || 0;
                this.state.stopCallCount = stopCount;
                var stopTimeout = setTimeout(function () {
                    _this.state.blockCount -= 1;
                    _this.updateInstanceBlockCount();
                    _this.detectChanges();
                }, delay);
                this.state.stopTimeouts.push(stopTimeout);
            }
        }
    };
    BlockUIContentComponent.prototype.onUpdate = function (_a) {
        var _this = this;
        var name = _a.name, message = _a.message;
        if (name === this.name) {
            var delay = this.delayStart || this.settings.delayStart || 0;
            clearTimeout(this.state.updateTimeouts[0]);
            var updateTimeout = setTimeout(function () {
                _this.updateMessage(message);
            }, delay);
            this.state.updateTimeouts.push(updateTimeout);
        }
    };
    BlockUIContentComponent.prototype.onReset = function (_a) {
        var name = _a.name;
        if (name === this.name) {
            this.resetState();
        }
    };
    BlockUIContentComponent.prototype.updateMessage = function (message) {
        this.showBlock(message);
    };
    BlockUIContentComponent.prototype.showBlock = function (message) {
        this.message = message || this.defaultMessage || this.settings.message;
        this.updateBlockTemplate(this.message);
        this.detectChanges();
    };
    BlockUIContentComponent.prototype.updateBlockTemplate = function (msg) {
        if (this.templateCompRef && this.templateCompRef instanceof ComponentRef) {
            this.templateCompRef.instance.message = msg;
        }
    };
    BlockUIContentComponent.prototype.resetState = function () {
        __spread(this.state.startTimeouts, this.state.stopTimeouts, this.state.updateTimeouts).forEach(clearTimeout);
        this.state = __assign({}, this.defaultBlockState);
        this.updateInstanceBlockCount();
        this.detectChanges();
    };
    BlockUIContentComponent.prototype.onUnsubscribe = function (name) {
        if (this.blockUISubscription && name === this.name) {
            this.blockUISubscription.unsubscribe();
        }
    };
    BlockUIContentComponent.prototype.updateInstanceBlockCount = function () {
        if (this.blockUI.blockUIInstances[this.name]) {
            var blockCount = this.state.blockCount;
            this.blockUI.blockUIInstances[this.name].blockCount = blockCount;
        }
    };
    BlockUIContentComponent.prototype.detectChanges = function () {
        if (!this.changeDetectionRef['destroyed']) {
            this.changeDetectionRef.detectChanges();
        }
    };
    BlockUIContentComponent.prototype.ngOnDestroy = function () {
        this.resetState();
        this.onUnsubscribe(this.name);
        this.blockUI.clearInstance(this.name);
    };
    BlockUIContentComponent.ctorParameters = function () { return [
        { type: BlockUIInstanceService },
        { type: ComponentFactoryResolver },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        Input()
    ], BlockUIContentComponent.prototype, "name", void 0);
    __decorate([
        Input()
    ], BlockUIContentComponent.prototype, "delayStart", void 0);
    __decorate([
        Input()
    ], BlockUIContentComponent.prototype, "delayStop", void 0);
    __decorate([
        Input('message')
    ], BlockUIContentComponent.prototype, "defaultMessage", void 0);
    __decorate([
        Input('template')
    ], BlockUIContentComponent.prototype, "templateCmp", void 0);
    __decorate([
        ViewChild('templateOutlet', { read: ViewContainerRef })
    ], BlockUIContentComponent.prototype, "templateOutlet", void 0);
    BlockUIContentComponent = __decorate([
        Component({
            selector: 'block-ui-content',
            template: template,
            encapsulation: ViewEncapsulation.None,
            styles: [styles]
        })
    ], BlockUIContentComponent);
    return BlockUIContentComponent;
}());
export { BlockUIContentComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stdWktY29udGVudC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1ibG9jay11aS8iLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYmxvY2stdWktY29udGVudC9ibG9jay11aS1jb250ZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sYUFBYSxFQUNiLGdCQUFnQixFQUNoQixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLFdBQVcsRUFDWCx3QkFBd0IsRUFDeEIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVsRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDcEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQWtCakU7SUF5QkUsaUNBQ1UsT0FBK0IsRUFDL0IsUUFBa0MsRUFDbEMsa0JBQXFDO1FBRnJDLFlBQU8sR0FBUCxPQUFPLENBQXdCO1FBQy9CLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBbUI7UUEzQnRDLFNBQUksR0FBVyxrQkFBa0IsQ0FBQztRQVEzQyxzQkFBaUIsR0FBZTtZQUM5QixhQUFhLEVBQUUsRUFBRTtZQUNqQixZQUFZLEVBQUUsRUFBRTtZQUNoQixjQUFjLEVBQUUsRUFBRTtZQUNsQixVQUFVLEVBQUUsQ0FBQztZQUNiLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLGFBQWEsRUFBRSxDQUFDO1NBQ2pCLENBQUM7UUFDRixVQUFLLGdCQUFvQixJQUFJLENBQUMsaUJBQWlCLEVBQUc7SUFZOUMsQ0FBQztJQUVMLDBDQUFRLEdBQVI7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDM0MsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVELGlEQUFlLEdBQWY7UUFDRSxJQUFJO1lBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JCLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFFRCxJQUFJLElBQUksQ0FBQyxXQUFXLFlBQVksV0FBVyxFQUFFO2dCQUMzQyxJQUFJLENBQUMsY0FBYyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUMxRDtpQkFBTTtnQkFDTCxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDN0UsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDekUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN4QztTQUNGO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUN0QztJQUNILENBQUM7SUFFRCxvREFBa0IsR0FBbEI7UUFDRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVPLG9EQUFrQixHQUExQixVQUEyQixRQUF5QjtRQUFwRCxpQkFFQztRQURDLE9BQU8sUUFBUSxDQUFDLFNBQVMsQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsRUFBN0IsQ0FBNkIsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFTyxtREFBaUIsR0FBekIsVUFBMEIsS0FBbUI7UUFDM0MsUUFBUSxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3BCLEtBQUssY0FBYyxDQUFDLEtBQUs7Z0JBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BCLE1BQU07WUFFUixLQUFLLGNBQWMsQ0FBQyxJQUFJO2dCQUN0QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixNQUFNO1lBRVIsS0FBSyxjQUFjLENBQUMsTUFBTTtnQkFDeEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDckIsTUFBTTtZQUVSLEtBQUssY0FBYyxDQUFDLEtBQUs7Z0JBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BCLE1BQU07WUFFUixLQUFLLGNBQWMsQ0FBQyxZQUFZO2dCQUM5QixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ2xCLE1BQU07WUFFUixLQUFLLGNBQWMsQ0FBQyxXQUFXO2dCQUM3QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0IsTUFBTTtTQUNUO0lBQ0gsQ0FBQztJQUVPLHlDQUFPLEdBQWYsVUFBZ0IsRUFBK0I7UUFBL0MsaUJBWUM7WUFaaUIsY0FBSSxFQUFFLG9CQUFPO1FBQzdCLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDdEIsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7WUFFL0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLElBQUksQ0FBQyxDQUFDO1lBQy9CLElBQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQztnQkFDOUIsS0FBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDO2dCQUMzQixLQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN4QixLQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztZQUNsQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDVixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDN0M7SUFDSCxDQUFDO0lBRU8sd0NBQU0sR0FBZCxVQUFlLEVBQXNCO1FBQXJDLGlCQWdCQztZQWhCZ0IsY0FBSTtRQUNuQixJQUFJLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ3RCLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztZQUUvQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLFNBQVMsSUFBSSxDQUFDLEVBQUU7Z0JBQzlDLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDO2dCQUU3RCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUM7Z0JBQ3JDLElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQztvQkFDN0IsS0FBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDO29CQUMzQixLQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztvQkFDaEMsS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUN2QixDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ1YsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzNDO1NBQ0Y7SUFDSCxDQUFDO0lBRU8sMENBQVEsR0FBaEIsVUFBaUIsRUFBK0I7UUFBaEQsaUJBVUM7WUFWa0IsY0FBSSxFQUFFLG9CQUFPO1FBQzlCLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDdEIsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7WUFFL0QsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsSUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFDO2dCQUMvQixLQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlCLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUM7SUFFTyx5Q0FBTyxHQUFmLFVBQWdCLEVBQXNCO1lBQXBCLGNBQUk7UUFDcEIsSUFBSSxJQUFJLEtBQUssSUFBSSxDQUFDLElBQUksRUFBRTtZQUN0QixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkI7SUFDSCxDQUFDO0lBRU8sK0NBQWEsR0FBckIsVUFBc0IsT0FBZTtRQUNuQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFTywyQ0FBUyxHQUFqQixVQUFrQixPQUFZO1FBQzVCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxJQUFJLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7UUFDdkUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVPLHFEQUFtQixHQUEzQixVQUE0QixHQUFRO1FBQ2xDLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsZUFBZSxZQUFZLFlBQVksRUFBRTtZQUN4RSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO1NBQzdDO0lBQ0gsQ0FBQztJQUVPLDRDQUFVLEdBQWxCO1FBQ0UsU0FDSyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQ3ZCLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUM1QixPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssZ0JBQVEsSUFBSSxDQUFDLGlCQUFpQixDQUFFLENBQUM7UUFDM0MsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFTywrQ0FBYSxHQUFyQixVQUFzQixJQUFZO1FBQ2hDLElBQUksSUFBSSxDQUFDLG1CQUFtQixJQUFJLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ2xELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUN4QztJQUNILENBQUM7SUFFTywwREFBd0IsR0FBaEM7UUFDRSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3BDLElBQUEsa0NBQVUsQ0FBZ0I7WUFDbEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztTQUNsRTtJQUNILENBQUM7SUFFTywrQ0FBYSxHQUFyQjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDekMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3pDO0lBQ0gsQ0FBQztJQUVELDZDQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7O2dCQXJLa0Isc0JBQXNCO2dCQUNyQix3QkFBd0I7Z0JBQ2QsaUJBQWlCOztJQTNCdEM7UUFBUixLQUFLLEVBQUU7eURBQW1DO0lBQ2xDO1FBQVIsS0FBSyxFQUFFOytEQUFvQjtJQUNuQjtRQUFSLEtBQUssRUFBRTs4REFBbUI7SUFDVDtRQUFqQixLQUFLLENBQUMsU0FBUyxDQUFDO21FQUF3QjtJQUN0QjtRQUFsQixLQUFLLENBQUMsVUFBVSxDQUFDO2dFQUFrQjtJQUVwQztRQURDLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxDQUFDO21FQUN2QjtJQVB0Qix1QkFBdUI7UUFObkMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLGtCQUFrQjtZQUM1QixRQUFRLEVBQUUsUUFBUTtZQUVsQixhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTtxQkFENUIsTUFBTTtTQUVoQixDQUFDO09BQ1csdUJBQXVCLENBZ01uQztJQUFELDhCQUFDO0NBQUEsQUFoTUQsSUFnTUM7U0FoTVksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBPbkluaXQsXG4gIEFmdGVyVmlld0luaXQsXG4gIEFmdGVyVmlld0NoZWNrZWQsXG4gIE9uRGVzdHJveSxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG4gIElucHV0LFxuICBWaWV3Q2hpbGQsXG4gIENvbXBvbmVudFJlZixcbiAgVGVtcGxhdGVSZWYsXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgQ2hhbmdlRGV0ZWN0b3JSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgQmxvY2tVSUluc3RhbmNlU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Jsb2NrLXVpLWluc3RhbmNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQmxvY2tVSUV2ZW50IH0gZnJvbSAnLi4vLi4vbW9kZWxzL2Jsb2NrLXVpLWV2ZW50Lm1vZGVsJztcbmltcG9ydCB7IEJsb2NrVUlBY3Rpb25zIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL2Jsb2NrLXVpLWFjdGlvbnMuY29uc3RhbnQnO1xuaW1wb3J0IHsgQmxvY2tVSURlZmF1bHROYW1lIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL2Jsb2NrLXVpLWRlZmF1bHQtbmFtZS5jb25zdGFudCc7XG5pbXBvcnQgeyBzdHlsZXMgfSBmcm9tICcuL2Jsb2NrLXVpLWNvbnRlbnQuY29tcG9uZW50LnN0eWxlJztcbmltcG9ydCB7IHRlbXBsYXRlIH0gZnJvbSAnLi9ibG9jay11aS1jb250ZW50LmNvbXBvbmVudC50ZW1wbGF0ZSc7XG5pbXBvcnQgeyBCbG9ja1VJU2V0dGluZ3MgfSBmcm9tICcuLi8uLi9tb2RlbHMvYmxvY2stdWktc2V0dGluZ3MubW9kZWwnO1xuXG5leHBvcnQgdHlwZSBCbG9ja1N0YXRlID0ge1xuICBzdGFydFRpbWVvdXRzOiBBcnJheTxhbnk+O1xuICBzdG9wVGltZW91dHM6IEFycmF5PGFueT47XG4gIHVwZGF0ZVRpbWVvdXRzOiBBcnJheTxhbnk+O1xuICBibG9ja0NvdW50OiBudW1iZXI7XG4gIHN0YXJ0Q2FsbENvdW50OiBudW1iZXI7XG4gIHN0b3BDYWxsQ291bnQ6IG51bWJlcjtcbn07XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2Jsb2NrLXVpLWNvbnRlbnQnLFxuICB0ZW1wbGF0ZTogdGVtcGxhdGUsXG4gIHN0eWxlczogW3N0eWxlc10sIC8vIFRPRE86IEZpbmQgaG93IHRvIGJ1bmRsZSBzdHlsZXMgZm9yIG5wbVxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIEJsb2NrVUlDb250ZW50Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBBZnRlclZpZXdDaGVja2VkLCBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSBuYW1lOiBzdHJpbmcgPSBCbG9ja1VJRGVmYXVsdE5hbWU7XG4gIEBJbnB1dCgpIGRlbGF5U3RhcnQ6IG51bWJlcjtcbiAgQElucHV0KCkgZGVsYXlTdG9wOiBudW1iZXI7XG4gIEBJbnB1dCgnbWVzc2FnZScpIGRlZmF1bHRNZXNzYWdlOiBzdHJpbmc7XG4gIEBJbnB1dCgndGVtcGxhdGUnKSB0ZW1wbGF0ZUNtcDogYW55O1xuICBAVmlld0NoaWxkKCd0ZW1wbGF0ZU91dGxldCcsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiB9KVxuICB0ZW1wbGF0ZU91dGxldDogVmlld0NvbnRhaW5lclJlZjtcblxuICBkZWZhdWx0QmxvY2tTdGF0ZTogQmxvY2tTdGF0ZSA9IHtcbiAgICBzdGFydFRpbWVvdXRzOiBbXSxcbiAgICBzdG9wVGltZW91dHM6IFtdLFxuICAgIHVwZGF0ZVRpbWVvdXRzOiBbXSxcbiAgICBibG9ja0NvdW50OiAwLFxuICAgIHN0YXJ0Q2FsbENvdW50OiAwLFxuICAgIHN0b3BDYWxsQ291bnQ6IDBcbiAgfTtcbiAgc3RhdGU6IEJsb2NrU3RhdGUgPSB7IC4uLnRoaXMuZGVmYXVsdEJsb2NrU3RhdGUgfTtcbiAgY2xhc3NOYW1lOiBzdHJpbmc7XG4gIHRlbXBsYXRlQ29tcFJlZjogQ29tcG9uZW50UmVmPHsgbWVzc2FnZT86IGFueSB9PiB8IFRlbXBsYXRlUmVmPHt9PjtcbiAgbWVzc2FnZTogYW55O1xuXG4gIHByaXZhdGUgYmxvY2tVSVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIHNldHRpbmdzOiBCbG9ja1VJU2V0dGluZ3M7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBibG9ja1VJOiBCbG9ja1VJSW5zdGFuY2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdGlvblJlZjogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7IH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnNldHRpbmdzID0gdGhpcy5ibG9ja1VJLmdldFNldHRpbmdzKCk7XG4gICAgdGhpcy5ibG9ja1VJU3Vic2NyaXB0aW9uID0gdGhpcy5zdWJzY3JpYmVUb0Jsb2NrVUkodGhpcy5ibG9ja1VJLm9ic2VydmUoKSk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGhpcy50ZW1wbGF0ZUNtcCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnRlbXBsYXRlQ21wIGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpIHtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZU91dGxldC5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy50ZW1wbGF0ZUNtcCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZUNvbXAgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KHRoaXMudGVtcGxhdGVDbXApO1xuICAgICAgICB0aGlzLnRlbXBsYXRlQ29tcFJlZiA9IHRoaXMudGVtcGxhdGVPdXRsZXQuY3JlYXRlQ29tcG9uZW50KHRlbXBsYXRlQ29tcCk7XG4gICAgICAgIHRoaXMudXBkYXRlQmxvY2tUZW1wbGF0ZSh0aGlzLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCduZy1ibG9jay11aTonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdDaGVja2VkKCkge1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVUb0Jsb2NrVUkoYmxvY2tVSSQ6IE9ic2VydmFibGU8YW55Pik6IFN1YnNjcmlwdGlvbiB7XG4gICAgcmV0dXJuIGJsb2NrVUkkLnN1YnNjcmliZShldmVudCA9PiB0aGlzLm9uRGlzcGF0Y2hlZEV2ZW50KGV2ZW50KSk7XG4gIH1cblxuICBwcml2YXRlIG9uRGlzcGF0Y2hlZEV2ZW50KGV2ZW50OiBCbG9ja1VJRXZlbnQpIHtcbiAgICBzd2l0Y2ggKGV2ZW50LmFjdGlvbikge1xuICAgICAgY2FzZSBCbG9ja1VJQWN0aW9ucy5TVEFSVDpcbiAgICAgICAgdGhpcy5vblN0YXJ0KGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQmxvY2tVSUFjdGlvbnMuU1RPUDpcbiAgICAgICAgdGhpcy5vblN0b3AoZXZlbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCbG9ja1VJQWN0aW9ucy5VUERBVEU6XG4gICAgICAgIHRoaXMub25VcGRhdGUoZXZlbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCbG9ja1VJQWN0aW9ucy5SRVNFVDpcbiAgICAgICAgdGhpcy5vblJlc2V0KGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQmxvY2tVSUFjdGlvbnMuUkVTRVRfR0xPQkFMOlxuICAgICAgICB0aGlzLnJlc2V0U3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQmxvY2tVSUFjdGlvbnMuVU5TVUJTQ1JJQkU6XG4gICAgICAgIHRoaXMub25TdG9wKGV2ZW50KTtcbiAgICAgICAgdGhpcy5vblVuc3Vic2NyaWJlKGV2ZW50Lm5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uU3RhcnQoeyBuYW1lLCBtZXNzYWdlIH06IEJsb2NrVUlFdmVudCkge1xuICAgIGlmIChuYW1lID09PSB0aGlzLm5hbWUpIHtcbiAgICAgIGNvbnN0IGRlbGF5ID0gdGhpcy5kZWxheVN0YXJ0IHx8IHRoaXMuc2V0dGluZ3MuZGVsYXlTdGFydCB8fCAwO1xuXG4gICAgICB0aGlzLnN0YXRlLnN0YXJ0Q2FsbENvdW50ICs9IDE7XG4gICAgICBjb25zdCBzdGFydFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5zdGF0ZS5ibG9ja0NvdW50ICs9IDE7XG4gICAgICAgIHRoaXMuc2hvd0Jsb2NrKG1lc3NhZ2UpO1xuICAgICAgICB0aGlzLnVwZGF0ZUluc3RhbmNlQmxvY2tDb3VudCgpO1xuICAgICAgfSwgZGVsYXkpO1xuICAgICAgdGhpcy5zdGF0ZS5zdGFydFRpbWVvdXRzLnB1c2goc3RhcnRUaW1lb3V0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uU3RvcCh7IG5hbWUgfTogQmxvY2tVSUV2ZW50KSB7XG4gICAgaWYgKG5hbWUgPT09IHRoaXMubmFtZSkge1xuICAgICAgY29uc3Qgc3RvcENvdW50ID0gdGhpcy5zdGF0ZS5zdG9wQ2FsbENvdW50ICsgMTtcblxuICAgICAgaWYgKHRoaXMuc3RhdGUuc3RhcnRDYWxsQ291bnQgLSBzdG9wQ291bnQgPj0gMCkge1xuICAgICAgICBjb25zdCBkZWxheSA9IHRoaXMuZGVsYXlTdG9wIHx8IHRoaXMuc2V0dGluZ3MuZGVsYXlTdG9wIHx8IDA7XG5cbiAgICAgICAgdGhpcy5zdGF0ZS5zdG9wQ2FsbENvdW50ID0gc3RvcENvdW50O1xuICAgICAgICBjb25zdCBzdG9wVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdGUuYmxvY2tDb3VudCAtPSAxO1xuICAgICAgICAgIHRoaXMudXBkYXRlSW5zdGFuY2VCbG9ja0NvdW50KCk7XG4gICAgICAgICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICAgIH0sIGRlbGF5KTtcbiAgICAgICAgdGhpcy5zdGF0ZS5zdG9wVGltZW91dHMucHVzaChzdG9wVGltZW91dCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblVwZGF0ZSh7IG5hbWUsIG1lc3NhZ2UgfTogQmxvY2tVSUV2ZW50KSB7XG4gICAgaWYgKG5hbWUgPT09IHRoaXMubmFtZSkge1xuICAgICAgY29uc3QgZGVsYXkgPSB0aGlzLmRlbGF5U3RhcnQgfHwgdGhpcy5zZXR0aW5ncy5kZWxheVN0YXJ0IHx8IDA7XG5cbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnN0YXRlLnVwZGF0ZVRpbWVvdXRzWzBdKTtcbiAgICAgIGNvbnN0IHVwZGF0ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVNZXNzYWdlKG1lc3NhZ2UpO1xuICAgICAgfSwgZGVsYXkpO1xuICAgICAgdGhpcy5zdGF0ZS51cGRhdGVUaW1lb3V0cy5wdXNoKHVwZGF0ZVRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25SZXNldCh7IG5hbWUgfTogQmxvY2tVSUV2ZW50KSB7XG4gICAgaWYgKG5hbWUgPT09IHRoaXMubmFtZSkge1xuICAgICAgdGhpcy5yZXNldFN0YXRlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRoaXMuc2hvd0Jsb2NrKG1lc3NhZ2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93QmxvY2sobWVzc2FnZTogYW55KSB7XG4gICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZSB8fCB0aGlzLmRlZmF1bHRNZXNzYWdlIHx8IHRoaXMuc2V0dGluZ3MubWVzc2FnZTtcbiAgICB0aGlzLnVwZGF0ZUJsb2NrVGVtcGxhdGUodGhpcy5tZXNzYWdlKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlQmxvY2tUZW1wbGF0ZShtc2c6IGFueSk6IHZvaWQge1xuICAgIGlmICh0aGlzLnRlbXBsYXRlQ29tcFJlZiAmJiB0aGlzLnRlbXBsYXRlQ29tcFJlZiBpbnN0YW5jZW9mIENvbXBvbmVudFJlZikge1xuICAgICAgdGhpcy50ZW1wbGF0ZUNvbXBSZWYuaW5zdGFuY2UubWVzc2FnZSA9IG1zZztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlc2V0U3RhdGUoKSB7XG4gICAgW1xuICAgICAgLi4udGhpcy5zdGF0ZS5zdGFydFRpbWVvdXRzLFxuICAgICAgLi4udGhpcy5zdGF0ZS5zdG9wVGltZW91dHMsXG4gICAgICAuLi50aGlzLnN0YXRlLnVwZGF0ZVRpbWVvdXRzXG4gICAgXS5mb3JFYWNoKGNsZWFyVGltZW91dCk7XG4gICAgdGhpcy5zdGF0ZSA9IHsgLi4udGhpcy5kZWZhdWx0QmxvY2tTdGF0ZSB9O1xuICAgIHRoaXMudXBkYXRlSW5zdGFuY2VCbG9ja0NvdW50KCk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIG9uVW5zdWJzY3JpYmUobmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuYmxvY2tVSVN1YnNjcmlwdGlvbiAmJiBuYW1lID09PSB0aGlzLm5hbWUpIHtcbiAgICAgIHRoaXMuYmxvY2tVSVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSW5zdGFuY2VCbG9ja0NvdW50KCkge1xuICAgIGlmICh0aGlzLmJsb2NrVUkuYmxvY2tVSUluc3RhbmNlc1t0aGlzLm5hbWVdKSB7XG4gICAgICBjb25zdCB7IGJsb2NrQ291bnQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICB0aGlzLmJsb2NrVUkuYmxvY2tVSUluc3RhbmNlc1t0aGlzLm5hbWVdLmJsb2NrQ291bnQgPSBibG9ja0NvdW50O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGV0ZWN0Q2hhbmdlcygpIHtcbiAgICBpZiAoIXRoaXMuY2hhbmdlRGV0ZWN0aW9uUmVmWydkZXN0cm95ZWQnXSkge1xuICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rpb25SZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMucmVzZXRTdGF0ZSgpO1xuICAgIHRoaXMub25VbnN1YnNjcmliZSh0aGlzLm5hbWUpO1xuICAgIHRoaXMuYmxvY2tVSS5jbGVhckluc3RhbmNlKHRoaXMubmFtZSk7XG4gIH1cbn1cbiJdfQ==